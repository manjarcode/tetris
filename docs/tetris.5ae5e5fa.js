const t=["#FF6B6B","#FF9F1C","#FFD23F","#17C3B2","#227C9D","#8B5CF6","#E6E6EA"],e=["#C34C4C","#B36D14","#B8962E","#0F8175","#165166","#5A3EAB","#A1A1A5"];class n{constructor(t,e,n,i,s){this.x=t,this.y=e,this.color=n,this.matrix=i,this.snapshot=s}getPosition(){return new i(this.x,this.y)}getColor(){return this.color}canTranslate(t){return new n(this.x+t.x,this.y+t.y,this.color,this.matrix,this.snapshot).isValid()}translate(t){this.x=this.x+t.x,this.y=this.y+t.y}consolidate(){this.matrix.at(this.x,this.y).set(this.color)}toString(){return`(${this.x},${this.y})`}relativeTo(t){return new i(this.x-t.x,this.y-t.y)}takeSnapshot(){this.snapshot=[this.x,this.y]}isValid(){let t=this.x>=0&&this.x<10,e=this.y>=0&&this.y<20;return!!t&&!!e&&0===this.matrix.at(this.x,this.y).get()}}class i{constructor(t,e){this.x=t,this.y=e}*[Symbol.iterator](){yield this.x,yield this.y}toString(){return`${String(this.x)}${String(this.y)}`}}class s{#t;#e;#n;constructor(t,e,n){this.mainScreen=t,this.nextScreen=e,this.pieceBuilder=n,this.iteration=0,this.isOver=!1,this.#t=!1,this.#e=!1,this.active=this.pieceBuilder.getRandom(4,0),this.#n=this.pieceBuilder.getRandom(0,0),e.render(this.#n)}wannaLeft(){this.move=1}wannaRight(){this.move=2}wannaRotate(){this.#t=!0}tooglePause(){this.#e=!this.#e}over(){this.mainScreen.gameOver()}iterate(){this.#i(),this.#t&&(this.active.wannaRotate(),this.#t=!1),this.#s()&&this.#r(),this.#a()}#i(){1===this.move&&this.active.wannaLeft(),2===this.move&&this.active.wannaRight(),this.move=0}#s(){return this.iteration++%10==0}#r(){this.active.canDown()?this.active.down():this.#w()}#w(){this.#h(),this.mainScreen.clearLines(),this.#o()}#h(){this.active.destroy(),this.active=null,this.active=this.#n,this.active.translate(new i(4,0)),this.#n=null,this.#n=this.pieceBuilder.getRandom(1,1),this.nextScreen.render(this.#n)}#o(){this.isOver=!this.active.canDown()}#a(){this.mainScreen.render(this.active)}}class r{constructor(t){this.rotations=t}apply(t){let e=this.rotations.find(e=>e.from.x===t.x&&e.from.y===t.y);return e||console.log(`Rotation not found (${t.x},${t.y})`),e.to}}class a{constructor(t,e){this.from=t,this.to=e}}class w{#l;constructor(t,e,n){this.#l=t.sort((t,e)=>e.y-t.y),this.rotateCenter=e,this.rotateTable=n}getBlocks(){return this.#l}wannaLeft(){let t=new i(-1,0);this.translate(t)}wannaRight(){let t=new i(1,0);this.translate(t)}#c(t){return this.#l.every(e=>e.canTranslate(t))}translate(t){if(this.#c(t))for(let e of this.#l)e.translate(t)}wannaRotate(){this.canRotate()&&this.rotate()}canRotate(){throw Error("must be implemented")}rotate(){throw Error("must be implemented")}canDown(){let t=new i(0,1);return this.#c(t)}down(){let t=new i(0,1);this.translate(t)}destroy(){for(let t of this.#l)t.consolidate();for(let t of this.#l);}toString(){return this.#l.map(t=>t.toString())}}class h extends w{constructor(t,e,n){super(t,e,n)}canRotate(){return!!this.rotateTable&&this.getBlocks().reduce((t,e)=>{let n=e.relativeTo(this.rotateCenter),i=this.rotateTable.apply(n);return t&&e.canTranslate(i)},!0)}rotate(){for(let t of this.getBlocks()){let e=t.relativeTo(this.rotateCenter),n=this.rotateTable.apply(e);t.translate(n)}}}class o extends w{constructor(t,e,n,i){super(t,e,n),this.isInverted=!1,this.reverseRotateTable=i}canRotate(){if(!this.rotateTable)return!1;let t=this.isInverted?this.reverseRotateTable:this.rotateTable;return this.getBlocks().reduce((e,n)=>{let i=n.relativeTo(this.rotateCenter),s=t.apply(i);return e&&n.canTranslate(s)},!0)}rotate(){let t=this.isInverted?this.reverseRotateTable:this.rotateTable;for(let e of this.getBlocks()){let n=e.relativeTo(this.rotateCenter),i=t.apply(n);e.translate(i)}this.isInverted=!this.isInverted}}class l{constructor(t){this.matrix=t}getRandom(t,e){let n=[this.buildSquare,this.buildT,this.buildL,this.buildLPrime,this.buildS,this.buildSPrime,this.buildStick],i=Math.floor(Math.random()*n.length);return n[i].bind(this)(t,e)}buildSquare(t,e){let i=new n(t+0,e+0,1,this.matrix),s=new n(t+1,e+0,1,this.matrix);return new h([i,s,new n(t+0,e+1,1,this.matrix),new n(t+1,e+1,1,this.matrix)],null,null)}buildT(t,e){let s=new n(t+1,e+0,2,this.matrix),w=new n(t+1,e+1,2,this.matrix),o=new n(t+1,e+2,2,this.matrix);return new h([s,w,o,new n(t+0,e+1,2,this.matrix)],w,new r([new a(new i(0,0),new i(0,0)),new a(new i(-1,0),new i(1,-1)),new a(new i(1,0),new i(-1,1)),new a(new i(0,1),new i(-1,-1)),new a(new i(0,-1),new i(1,1))]))}buildL(t,e){let s=new n(t+0,e+0,3,this.matrix),w=new n(t+0,e+1,3,this.matrix),o=new n(t+0,e+2,3,this.matrix);return new h([s,w,o,new n(t+1,e+0,3,this.matrix)],w,new r([new a(new i(0,0),new i(0,0)),new a(new i(-1,0),new i(1,-1)),new a(new i(1,0),new i(-1,1)),new a(new i(0,1),new i(-1,-1)),new a(new i(0,-1),new i(1,1)),new a(new i(1,-1),new i(0,2)),new a(new i(1,1),new i(-2,0)),new a(new i(-1,1),new i(0,-2)),new a(new i(-1,-1),new i(2,0))]))}buildLPrime(t,e){let s=new n(t+1,e+0,4,this.matrix),w=new n(t+1,e+1,4,this.matrix),o=new n(t+1,e+2,4,this.matrix);return new h([s,w,o,new n(t+0,e+0,4,this.matrix)],w,new r([new a(new i(0,0),new i(0,0)),new a(new i(-1,0),new i(1,-1)),new a(new i(1,0),new i(-1,1)),new a(new i(0,1),new i(-1,-1)),new a(new i(0,-1),new i(1,1)),new a(new i(1,-1),new i(0,2)),new a(new i(1,1),new i(-2,0)),new a(new i(-1,1),new i(0,-2)),new a(new i(-1,-1),new i(2,0))]))}buildStick(t,e){let s=new n(t+0,e+0,5,this.matrix),w=new n(t+0,e+1,5,this.matrix),h=new n(t+0,e+2,5,this.matrix),l=new n(t+0,e+3,5,this.matrix);return new o([s,w,h,l],w,new r([new a(new i(0,0),new i(0,0)),new a(new i(0,-1),new i(-1,1)),new a(new i(0,1),new i(1,-1)),new a(new i(0,2),new i(2,-2))]),new r([new a(new i(0,0),new i(0,0)),new a(new i(-1,0),new i(1,-1)),new a(new i(1,0),new i(-1,1)),new a(new i(2,0),new i(-2,2))]))}buildS(t,e){let s=new n(t-1,e+0,6,this.matrix),w=new n(t+0,e+0,6,this.matrix),h=new n(t+0,e+1,6,this.matrix),l=new n(t+1,e+1,6,this.matrix);return new o([s,w,h,l],h,new r([new a(new i(0,0),new i(0,0)),new a(new i(-1,-1),new i(2,0)),new a(new i(0,-1),new i(1,1)),new a(new i(1,0),new i(-1,1))]),new r([new a(new i(0,0),new i(0,0)),new a(new i(1,-1),new i(-2,0)),new a(new i(1,0),new i(-1,-1)),new a(new i(0,1),new i(1,-1))]))}buildSPrime(t,e){let s=new n(t+1,e+0,7,this.matrix),w=new n(t+0,e+0,7,this.matrix),h=new n(t+0,e+1,7,this.matrix),l=new n(t-1,e+1,7,this.matrix);return new o([s,w,h,l],h,new r([new a(new i(0,0),new i(0,0)),new a(new i(1,-1),new i(-2,0)),new a(new i(0,-1),new i(-1,1)),new a(new i(-1,0),new i(1,1))]),new r([new a(new i(0,0),new i(0,0)),new a(new i(-1,-1),new i(2,0)),new a(new i(-1,0),new i(1,-1)),new a(new i(0,1),new i(-1,-1))]))}}class c{constructor(t,e){this.columns=t,this.rows=e,this.matrix=Array.from({length:t},()=>Array(e).fill(0))}getColumns(){return this.columns}getRows(){return this.rows}at(t,e){return this.x=t,this.y=e,this}get(){return this.#u(),this.matrix[this.x][this.y]}set(t){this.#u(),this.matrix[this.x][this.y]=t}#u(){var t,e;if(null==this.x||null==this.y)throw Error(`Coord (x,y) must be set but are (${this.x},${this.y})`)}clearLines(){for(let t of this.#m())this.#x(t)}#m(){let t=[];for(let e=0;e<this.rows;e++){let n=!0;for(let t=0;t<this.columns&&n;t++)n=this.matrix[t][e]>0&&n;n&&t.push(e)}return t}#x(t){for(let e=t;e>0;e--)for(let t=0;t<this.columns;t++){let n=this.matrix[t][e-1];this.matrix[t][e]=n}}}class u{constructor(t){this.canvas=t}matrix(t){for(let e=0;e<t.getColumns();e++)for(let n=0;n<t.getRows();n++){let i=t.at(e,n).get();this.cell(e,n,i)}}piece(t){for(let e of t.getBlocks()){let[t,n]=e.getPosition(),i=e.getColor();this.cell(t,n,i)}}cell(n,i,s){if(0===s)return;let r=40*n,a=40*i;this.canvas.fillStyle=t[s%t.length],this.canvas.fillRect(r,a,40,40),this.canvas.strokeStyle=e[s%e.length],this.canvas.strokeRect(r,a,40,40)}clear(){this.canvas.fillStyle="white",this.canvas.fillRect(0,0,400,800)}gameOver(){this.canvas.font="48px roboto",this.canvas.fillStyle="#000000",this.canvas.fillText("Game Over!",85,376)}}class m{constructor(t,e){this.matrix=t,this.drawer=e}render(t){this.drawer.clear(),this.drawer.matrix(this.matrix),this.drawer.piece(t)}clearLines(){this.matrix.clearLines()}gameOver(){this.drawer.gameOver()}static create(t,e){return new m(e,new u(document.getElementById(t).getContext("2d")))}}let x=null,d=null;const v={ArrowLeft:()=>x.wannaLeft(),ArrowRight:()=>x.wannaRight(),Space:()=>x.wannaRotate(),Escape:()=>x.tooglePause()};document.addEventListener("keyup",t=>{let{key:e,code:n}=t,i=v[n??e];i&&i()}),window.onload=()=>(function(){let t=new c(10,20),e=m.create("game",t),n=new l(t);(x=new s(e,m.create("next",new c(4,4)),n)).iterate(),d=window.setInterval(()=>{(function(){try{x.isOver||x.paused||x.iterate(),x.isOver&&(window.clearInterval(d),x.over())}catch(t){window.clearInterval(d),console.error(t)}})()},20)})();
//# sourceMappingURL=tetris.5ae5e5fa.js.map
